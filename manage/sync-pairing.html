<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#007bff">
    <title>üîó Synchronisation - Ratchou</title>

    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../assets/css/app.css">

    <!-- Theme detection (early execution) -->
    <script>
        (function() {
            const theme = localStorage.getItem('ratchou-theme') || 'auto';
            if (theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.setAttribute('data-bs-theme', 'dark');
            }
        })();
    </script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p id="loadingMessage" class="mt-3 text-white fw-bold">Chargement...</p>
        </div>
    </div>

    <!-- Container -->
    <div class="container-fluid mt-3">
        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Alert rate limit (masqu√© par d√©faut) -->
        <div id="rate-limit-alert" class="alert alert-warning d-none" role="alert">
            <h5>üö´ Synchronisation temporairement bloqu√©e</h5>
            <p>Trop de tentatives d√©tect√©es. La synchronisation reprendra automatiquement dans <strong id="rate-limit-countdown">--</strong>.</p>
            <button type="button" class="btn btn-sm btn-outline-warning" id="force-resume-sync">
                D√©bloquer manuellement
            </button>
        </div>

        <!-- Header will be injected here -->
        <div id="headerContainer"></div>

        <!-- Main Content -->
        <div class="row mt-3">
            <div class="col-12">
                <!-- Configuration API URL (visible si non configur√©e) -->
                <div id="apiUrlConfig" class="card mb-3" style="display: none;">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">‚öôÔ∏è Configuration requise</h5>
                    </div>
                    <div class="card-body">
                        <p>Avant de configurer la synchronisation, vous devez indiquer l'URL de votre serveur de synchronisation.</p>

                        <div class="mb-3">
                            <label for="apiUrlInput" class="form-label">URL du serveur de synchronisation</label>
                            <input type="url" class="form-control" id="apiUrlInput"
                                   placeholder="https://sync.example.com/api"
                                   value="">
                            <div class="form-text">
                                ‚ö†Ô∏è L'URL doit commencer par <code>https://</code>
                            </div>
                        </div>

                        <button class="btn btn-primary" id="saveApiUrlBtn">
                            üíæ Enregistrer et continuer
                        </button>
                    </div>
                </div>

                <!-- Accord√©on principal (visible apr√®s config API URL) -->
                <div id="pairingAccordion" class="accordion">

                    <!-- Section 1: Bootstrap Ma√Ætre -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#bootstrapMaster"
                                    aria-expanded="true">
                                üëë Fichiers d'appairage
                            </button>
                        </h2>
                        <div id="bootstrapMaster" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <!-- Formulaire de g√©n√©ration de fichier d'appairage -->
                                <div id="pairingDisplay">
                                    <div class="card" id="pairingFileGenerationSection">
                                        <div class="card-header bg-success text-white">
                                            <h5 class="mb-0">‚úÖ Appareil principal configur√©</h5>
                                        </div>
                                        <div class="card-body">
                                            <p>Cet appareil est configur√© comme <strong>appareil principal</strong>.</p>
                                            <p class="text-muted small">
                                                Pour associer un autre appareil, g√©n√©rez un fichier d'appairage ci-dessous.
                                            </p>

                                            <hr>

                                            <h6>üìÅ G√©n√©rer un fichier d'appairage</h6>
                                            <p class="text-muted small">
                                                Cr√©ez un fichier contenant toutes vos donn√©es et la configuration de synchronisation
                                                √† transf√©rer vers un nouvel appareil.
                                            </p>

                                            <form id="pairingFileForm" class="mt-3">
                                                <div class="mb-3">
                                                    <label for="pairingSecurityCode" class="form-label">Code de s√©curit√© (4 chiffres)</label>
                                                    <input type="tel" class="form-control text-center" id="pairingSecurityCode"
                                                           maxlength="4" placeholder="0000" pattern="[0-9]{4}" required>
                                                    <div class="form-text">Ce code sera demand√© lors de l'import</div>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="pairingTargetDeviceName" class="form-label">Nom du nouvel appareil</label>
                                                    <input type="text" class="form-control" id="pairingTargetDeviceName"
                                                           placeholder="Ex: iPhone de Marie" required>
                                                </div>

                                                <button type="submit" class="btn btn-primary w-100" id="generatePairingFileBtn">
                                                    üì• G√©n√©rer le fichier d'appairage
                                                </button>
                                            </form>

                                            <div class="alert alert-warning mt-3 small">
                                                ‚ö†Ô∏è <strong>Important :</strong> Transf√©rez le fichier de mani√®re s√©curis√©e
                                                et supprimez-le apr√®s l'import.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Pairing Esclave -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#pairingSlave">
                                üì± Associer cet appareil √† un autre
                            </button>
                        </h2>
                        <div id="pairingSlave" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="alert alert-info">
                                    <strong>‚ÑπÔ∏è Appareil secondaire</strong><br>
                                    Pour associer cet appareil √† un appareil principal existant,
                                    utilisez le fichier d'appairage g√©n√©r√© depuis l'appareil principal.
                                </div>

                                <div class="alert alert-primary d-flex align-items-center">
                                    <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                                    <div>
                                        <strong>Comment faire ?</strong><br>
                                        Retournez sur la <a href="../index.html" class="alert-link">page d'installation</a>,
                                        s√©lectionnez "J'ai un fichier d'appairage" et importez le fichier g√©n√©r√©
                                        depuis l'appareil principal.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Appareils associ√©s -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#deviceListSection">
                                üìã Appareils associ√©s
                            </button>
                        </h2>
                        <div id="deviceListSection" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div id="deviceListContainer">
                                    <p class="text-muted">Chargement...</p>
                                </div>

                                <button class="btn btn-outline-primary mt-3" id="refreshDeviceListBtn">
                                    üîÑ Actualiser la liste
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar injection point -->
    <div id="sidebarContainer"></div>

    <!-- ========== MODALS ========== -->

    <!-- Modal Recovery Key (obligatoire apr√®s bootstrap) -->
    <div class="modal fade" id="recoveryKeyModal" data-bs-backdrop="static" data-bs-keyboard="false"
         tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">üîë Cl√© de r√©cup√©ration - √Ä CONSERVER PR√âCIEUSEMENT</h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <strong>‚ö†Ô∏è CRITIQUE</strong> : Cette cl√© est indispensable pour r√©cup√©rer
                        vos donn√©es en cas de perte de l'appareil principal.
                        <br><br>
                        <strong>Sauvegardez-la dans un endroit s√ªr :</strong>
                        <ul class="mb-0">
                            <li>Gestionnaire de mots de passe</li>
                            <li>Coffre-fort num√©rique</li>
                            <li>Document papier dans un lieu s√©curis√©</li>
                        </ul>
                    </div>

                    <div class="text-center mb-3">
                        <code class="fs-5 user-select-all p-3 bg-light d-inline-block border rounded"
                              id="recoveryKeyDisplay">
                            RATCHOU-XXXX-XXXX-XXXX-XXXX-XXXX-XXXX-XXXX-XXXX
                        </code>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" id="copyRecoveryKeyBtn">
                            üìã Copier dans le presse-papier
                        </button>
                        <button class="btn btn-outline-secondary" id="downloadRecoveryKeyBtn">
                            üíæ T√©l√©charger en fichier texte
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox"
                               id="recoveryKeyConfirm" required>
                        <label class="form-check-label" for="recoveryKeyConfirm">
                            J'ai bien sauvegard√© ma cl√© de r√©cup√©ration
                        </label>
                    </div>
                    <button type="button" class="btn btn-primary"
                            id="closeRecoveryModal" disabled>
                        Continuer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmation Pairing (effacement donn√©es) -->
    <div class="modal fade" id="pairingConfirmModal" data-bs-backdrop="static" data-bs-keyboard="false"
         tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">‚ö†Ô∏è Confirmation requise</h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <h6 class="alert-heading">üóëÔ∏è Toutes vos donn√©es locales vont √™tre effac√©es</h6>
                        <p class="mb-0">
                            En associant cet appareil √† l'appareil principal, <strong>toutes les donn√©es actuellement
                            stock√©es sur cet appareil seront d√©finitivement supprim√©es</strong> et remplac√©es par
                            les donn√©es de l'appareil principal.
                        </p>
                    </div>

                    <h6>Ce qui va se passer :</h6>
                    <ul>
                        <li>‚úÖ Association avec l'appareil principal</li>
                        <li>üóëÔ∏è Effacement complet de vos donn√©es locales</li>
                        <li>‚¨áÔ∏è T√©l√©chargement des donn√©es depuis l'appareil principal</li>
                        <li>üîÑ Activation de la synchronisation automatique</li>
                    </ul>

                    <div class="alert alert-info">
                        <strong>üí° Conseil :</strong> Si vous avez des donn√©es importantes sur cet appareil
                        que vous souhaitez conserver, exportez-les avant de continuer.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelPairingBtn">
                        ‚ùå Annuler
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmPairingBtn">
                        ‚úÖ Confirmer et continuer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Common modals will be injected here -->
    <div id="modalsContainer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JSZip for pairing file generation -->
    <script src="../js/lib/jszip.min.js"></script>

    <!-- Core Ratchou Scripts -->
    <script src="../js/core/theme-manager.js"></script>
    <script src="../js/core/utils.js"></script>
    <script src="../js/core/indexeddb-wrapper.js"></script>

    <!-- Models -->
    <script src="../js/core/models/base-model.js"></script>
    <script src="../js/core/models/comptes-model.js"></script>
    <script src="../js/core/models/categories-model.js"></script>
    <script src="../js/core/models/beneficiaires-model.js"></script>
    <script src="../js/core/models/type_depenses-model.js"></script>
    <script src="../js/core/models/mouvements-model.js"></script>
    <script src="../js/core/models/recurrents-model.js"></script>

    <!-- Sync modules (Phase 1) -->
    <script src="../js/core/sync-crypto.js"></script>
    <script src="../js/core/network-client.js"></script>
    <script src="../js/core/sync-manager.js"></script>

    <!-- Import/Export (loaded early as module to ensure window.ImportExport is available) -->
    <script src="../js/components/import-export.js" type="module"></script>

    <!-- Auth & App -->
    <script src="../js/core/auth.js"></script>
    <script src="../js/core/ratchou-app.js"></script>

    <!-- Components -->
    <script src="../js/components/component-loader.js"></script>

    <!-- Page Controller -->
    <script src="../js/pages/sync-pairing.js"></script>

    <!-- PWA -->
    <script src="../js/pwa/install.js"></script>
</body>
</html>
